<!DOCTYPE html>
<html lang="<%= lang %>" dir="<%= dir %>">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= t.enterData %> - <%= t.hotelName %>
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <%- include('../partials/styles') %>
</head>

<body class="dashboard-bg">
    <!-- زر القائمة للموبايل -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Overlay للجوال -->
    <div class="overlay" id="overlay"></div>

    <!-- الشريط الجانبي -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <img src="/images/logo.png" alt="<%= t.hotelName %>"
                    onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiByeD0iNDAiIGZpbGw9IiNEMEFGMzciLz4KPC9zdmc+Cg=='">
            </div>
            <h5 class="text-gold mb-1">
                <%= t.hotelName %>
            </h5>
            <small class="text-light">
                <%= t.userDashboard %>
            </small>
        </div>

        <nav class="nav flex-column">
            <a href="/user/dashboard?lang=<%= lang %>" class="nav-link">
                <span class="nav-icon"><i class="fas fa-tachometer-alt"></i></span>
                <%= t.dashboard %>
            </a>
            <a href="/user/kpis?lang=<%= lang %>" class="nav-link">
                <span class="nav-icon"><i class="fas fa-chart-line"></i></span>
                <%= t.myKPIs %>
            </a>
            <a href="/user/projects?lang=<%= lang %>" class="nav-link">
                <span class="nav-icon"><i class="fas fa-tasks"></i></span>
                <%= t.projectsTracking %>
            </a>
            <a href="/user/reports?lang=<%= lang %>" class="nav-link">
                <span class="nav-icon"><i class="fas fa-flag"></i></span>
                <%= t.reportsTracking %>
            </a>
            <a href="/user/data?lang=<%= lang %>" class="nav-link active">
                <span class="nav-icon"><i class="fas fa-edit"></i></span>
                <%= t.enterData %>
            </a>
            <a href="/user/profile?lang=<%= lang %>" class="nav-link">
                <span class="nav-icon"><i class="fas fa-user"></i></span>
                <%= t.profile %>
            </a>
        </nav>

        <div class="mt-auto p-3 border-top">
            <form action="/logout" method="POST" class="d-grid">
                <input type="hidden" name="lang" value="<%= lang %>">
                <button type="submit" class="btn btn-outline-luxury">
                    <i class="fas fa-sign-out-alt me-2"></i>
                    <%= t.logout %>
                </button>
            </form>
        </div>
    </div>

    <!-- المحتوى الرئيسي -->
    <div class="dashboard-content">
        <nav class="navbar navbar-luxury">
            <div class="navbar-content">
                <div class="navbar-left">
                    <h4 class="mb-0 text-dark">
                        <i class="fas fa-edit text-gold me-2"></i>
                        <%= t.enterData %>
                    </h4>
                </div>

                <div class="navbar-right">
                    <div class="language-menu">
                        <a href="?lang=<%= lang === 'ar' ? 'en' : 'ar' %>" class="btn btn-lang">
                            <i class="fas fa-globe me-2"></i>
                            <%= lang==='ar' ? 'English' : 'العربية' %>
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="content-wrapper">
            <div class="dashboard-header mb-4">
                <h1 class="welcome-message">
                    <i class="fas fa-edit text-gold me-2"></i>
                    <%= t.enterData %>
                </h1>
                <p class="sub-message">
                    <%= lang==='ar' ? 'إدخال بيانات الأداء والمؤشرات اليومية'
                        : 'Enter daily performance data and indicators' %>
                </p>
            </div>

            <!-- إحصائيات سريعة -->
            <div class="row mt-4 mb-4">
                <div class="col-md-4">
                    <div class="luxury-card text-center">
                        <div class="p-4">
                            <i class="fas fa-database fa-2x text-gold mb-3"></i>
                            <h3 class="text-gold">
                                <%= (userKPIs ? userKPIs.length : 0) + (userProjects ? userProjects.length : 0) %>
                            </h3>
                            <p class="text-muted mb-0">
                                <%= lang==='ar' ? 'إجمالي العناصر' : 'Total Items' %>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="luxury-card text-center">
                        <div class="p-4">
                            <i class="fas fa-check-circle fa-2x text-gold mb-3"></i>
                            <h3 class="text-gold">
                                <%= (userProjects ? userProjects.filter(p=> p.status === 'completed').length : 0) +
                                    (userKPIs ? userKPIs.filter(k => k.status === 'مكتمل').length : 0) %>
                            </h3>
                            <p class="text-muted mb-0">
                                <%= lang==='ar' ? 'مكتملة' : 'Completed' %>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="luxury-card text-center">
                        <div class="p-4">
                            <i class="fas fa-clock fa-2x text-gold mb-3"></i>
                            <h3 class="text-gold">
                                <%= (userProjects ? userProjects.filter(p=> p.status === 'in-progress' || p.status ===
                                    'pending').length : 0) + (userKPIs ? userKPIs.filter(k => k.status !==
                                    'مكتمل').length : 0) %>
                            </h3>
                            <p class="text-muted mb-0">
                                <%= lang==='ar' ? 'قيد العمل' : 'In Progress' %>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- نماذج إدخال البيانات -->
            <div class="row">
                <!-- أزرار الإجراءات السريعة -->
                <div class="row mb-5">
                    <div class="col-md-6 mb-4">
                        <div class="luxury-card h-100 text-center p-5 action-card" data-bs-toggle="modal"
                            data-bs-target="#updateKPIModal">
                            <div class="icon-wrapper mb-4">
                                <i class="fas fa-chart-line fa-3x text-gold"></i>
                            </div>
                            <h3 class="text-gold mb-3">
                                <%= lang==='ar' ? 'تحديث مؤشر أداء' : 'Update KPI' %>
                            </h3>
                            <p class="text-muted">
                                <%= lang==='ar' ? 'تسجيل قراءة جديدة لمؤشر أداء وتحديث حالته'
                                    : 'Record a new KPI reading and update its status' %>
                            </p>
                            <button class="btn btn-luxury mt-3">
                                <i class="fas fa-plus me-2"></i>
                                <%= lang==='ar' ? 'بدء التحديث' : 'Start Update' %>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="luxury-card h-100 text-center p-5 action-card" data-bs-toggle="modal"
                            data-bs-target="#updateProjectModal">
                            <div class="icon-wrapper mb-4">
                                <i class="fas fa-tasks fa-3x text-gold"></i>
                            </div>
                            <h3 class="text-gold mb-3">
                                <%= lang==='ar' ? 'تحديث تقدم مشروع' : 'Update Project' %>
                            </h3>
                            <p class="text-muted">
                                <%= lang==='ar' ? 'تحديث نسبة الإنجاز وحالة المشاريع الجارية'
                                    : 'Update completion percentage and status of ongoing projects' %>
                            </p>
                            <button class="btn btn-luxury mt-3">
                                <i class="fas fa-plus me-2"></i>
                                <%= lang==='ar' ? 'بدء التحديث' : 'Start Update' %>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal تحديث مؤشر الأداء -->
                <div class="modal fade" id="updateKPIModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content luxury-card border-0">
                            <div class="modal-header border-bottom-gold">
                                <h5 class="modal-title text-gold">
                                    <i class="fas fa-chart-line me-2"></i>
                                    <%= lang==='ar' ? 'تحديث مؤشر الأداء' : 'Update KPI' %>
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-4">
                                <form action="/user/data/kpi?lang=<%= lang %>" method="POST">
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <%= lang==='ar' ? 'مؤشر الأداء' : 'Performance Indicator' %>
                                        </label>
                                        <select class="form-select" name="kpiId" required>
                                            <option value="">
                                                <%= lang==='ar' ? 'اختر المؤشر' : 'Select Indicator' %>
                                            </option>
                                            <% if (userKPIs && userKPIs.length> 0) { %>
                                                <% userKPIs.forEach(kpi=> { %>
                                                    <option value="<%= kpi._id %>">
                                                        <%= lang==='ar' ? kpi.name.ar : kpi.name.en %>
                                                            (<%= lang==='ar' ? 'الحالي' : 'Current' %>: <%=
                                                                    kpi.currentValue %>
                                                                    <%= kpi.unit %>)
                                                    </option>
                                                    <% }); %>
                                                        <% } else { %>
                                                            <option value="" disabled>
                                                                <%= lang==='ar' ? 'لا توجد مؤشرات متاحة'
                                                                    : 'No KPIs available' %>
                                                            </option>
                                                            <% } %>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <%= lang==='ar' ? 'القيمة الجديدة' : 'New Value' %>
                                        </label>
                                        <input type="number" class="form-control" name="value"
                                            placeholder="<%= lang === 'ar' ? 'أدخل القيمة' : 'Enter value' %>"
                                            step="0.01" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <%= lang==='ar' ? 'ملاحظات' : 'Notes' %>
                                        </label>
                                        <textarea class="form-control" name="notes" rows="3"
                                            placeholder="<%= lang === 'ar' ? 'أدخل أي ملاحظات إضافية' : 'Enter any additional notes' %>"></textarea>
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-luxury">
                                            <i class="fas fa-save me-2"></i>
                                            <%= t.save %>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal تحديث المشروع -->
                <div class="modal fade" id="updateProjectModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content luxury-card border-0">
                            <div class="modal-header border-bottom-gold">
                                <h5 class="modal-title text-gold">
                                    <i class="fas fa-tasks me-2"></i>
                                    <%= lang==='ar' ? 'تحديث تقدم المشاريع' : 'Update Project Progress' %>
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-4">
                                <form action="/user/data/project?lang=<%= lang %>" method="POST">
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <%= lang==='ar' ? 'المشروع' : 'Project' %>
                                        </label>
                                        <select class="form-select" name="projectId" required>
                                            <option value="">
                                                <%= lang==='ar' ? 'اختر المشروع' : 'Select Project' %>
                                            </option>
                                            <% if (userProjects && userProjects.length> 0) { %>
                                                <% userProjects.forEach(project=> { %>
                                                    <option value="<%= project._id %>">
                                                        <%= lang==='ar' ? project.name.ar : project.name.en %>
                                                    </option>
                                                    <% }); %>
                                                        <% } else { %>
                                                            <option value="" disabled>
                                                                <%= lang==='ar' ? 'لا توجد مشاريع متاحة'
                                                                    : 'No Projects available' %>
                                                            </option>
                                                            <% } %>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <%= lang==='ar' ? 'نسبة الإنجاز' : 'Completion Percentage' %>
                                        </label>
                                        <input type="range" class="form-range" name="progress" min="0" max="100"
                                            step="1" id="progressRange"
                                            oninput="document.getElementById('rangeValue').innerText = this.value + '%'">
                                        <div class="d-flex justify-content-between">
                                            <small>0%</small>
                                            <small id="rangeValue">0%</small>
                                            <small>100%</small>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <%= lang==='ar' ? 'الحالة' : 'Status' %>
                                        </label>
                                        <select class="form-select" name="status">
                                            <option value="pending">
                                                <%= t.pending %>
                                            </option>
                                            <option value="in-progress">
                                                <%= t.inProgress %>
                                            </option>
                                            <option value="completed">
                                                <%= t.completed %>
                                            </option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <%= lang==='ar' ? 'ملاحظات' : 'Notes' %>
                                        </label>
                                        <textarea class="form-control" name="notes" rows="3"
                                            placeholder="<%= lang === 'ar' ? 'أدخل تحديثات حول تقدم المشروع' : 'Enter updates about project progress' %>"></textarea>
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-luxury">
                                            <i class="fas fa-sync-alt me-2"></i>
                                            <%= t.update %>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- البيانات المدخلة حديثاً (عرض آخر التحديثات على KPIs والمشاريع) -->
            <div class="luxury-card">
                <div class="p-3 border-bottom">
                    <h5 class="mb-0 text-gold">
                        <i class="fas fa-history me-2"></i>
                        <%= lang==='ar' ? 'آخر التحديثات' : 'Recent Updates' %>
                    </h5>
                </div>
                <div class="p-3">
                    <div class="table-responsive">
                        <table class="table table-luxury table-hover">
                            <thead>
                                <tr>
                                    <th>
                                        <%= lang==='ar' ? 'النوع' : 'Type' %>
                                    </th>
                                    <th>
                                        <%= lang==='ar' ? 'الاسم' : 'Name' %>
                                    </th>
                                    <th>
                                        <%= lang==='ar' ? 'القيمة / التقدم' : 'Value / Progress' %>
                                    </th>
                                    <th>
                                        <%= lang==='ar' ? 'الحالة' : 'Status' %>
                                    </th>
                                    <th>
                                        <%= lang==='ar' ? 'آخر تحديث' : 'Last Updated' %>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if ((!userKPIs || userKPIs.length===0) && (!userProjects || userProjects.length===0))
                                    { %>
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            <%= lang==='ar' ? 'لا توجد بيانات' : 'No data available' %>
                                        </td>
                                    </tr>
                                    <% } %>

                                        <% if (userKPIs) { userKPIs.forEach(kpi=> { %>
                                            <tr>
                                                <td><span class="badge bg-info">
                                                        <%= lang==='ar' ? 'مؤشر أداء' : 'KPI' %>
                                                    </span></td>
                                                <td>
                                                    <%= lang==='ar' ? kpi.name.ar : kpi.name.en %>
                                                </td>
                                                <td><strong>
                                                        <%= kpi.currentValue %>
                                                            <%= kpi.unit %>
                                                    </strong></td>
                                                <td>
                                                    <span
                                                        class="badge <%= kpi.status === 'مكتمل' ? 'bg-success' : 'bg-warning' %>">
                                                        <%= kpi.status %>
                                                    </span>
                                                </td>
                                                <td>
                                                    <%= new Date(kpi.updatedAt).toLocaleDateString(lang==='ar' ? 'ar-SA'
                                                        : 'en-US' ) %>
                                                </td>
                                            </tr>
                                            <% }); } %>

                                                <% if (userProjects) { userProjects.forEach(project=> { %>
                                                    <tr>
                                                        <td><span class="badge bg-primary">
                                                                <%= lang==='ar' ? 'مشروع' : 'Project' %>
                                                            </span></td>
                                                        <td>
                                                            <%= lang==='ar' ? project.name.ar : project.name.en %>
                                                        </td>
                                                        <td>
                                                            <div class="progress" style="height: 20px;">
                                                                <div class="progress-bar bg-gold" role="progressbar"
                                                                    style="width: <%= project.progress %>%;"
                                                                    aria-valuenow="<%= project.progress %>"
                                                                    aria-valuemin="0" aria-valuemax="100">
                                                                    <%= project.progress %>%
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <span
                                                                class="badge <%= project.status === 'completed' ? 'bg-success' : (project.status === 'in-progress' ? 'bg-primary' : 'bg-warning') %>">
                                                                <%= project.status %>
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <%= new
                                                                Date(project.updatedAt).toLocaleDateString(lang==='ar'
                                                                ? 'ar-SA' : 'en-US' ) %>
                                                        </td>
                                                    </tr>
                                                    <% }); } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // كود تبديل القائمة الجانبية
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        function toggleSidebar() {
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        mobileMenuBtn.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', toggleSidebar);

        // تحديث قيمة المدى
        const progressRange = document.getElementById('progressRange');
        const rangeValue = document.getElementById('rangeValue');

        progressRange.addEventListener('input', function () {
            rangeValue.textContent = this.value + '%';
        });
    </script>
</body>

</html>