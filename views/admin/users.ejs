<!DOCTYPE html>
<html lang="<%= lang %>" dir="<%= dir %>">
<head>
    <%- include('../partials/head') %>
</head>
<body class="dashboard-bg">
    <%- include('../partials/sidebar') %>
    
    <div class="main-content">
        <%- include('../partials/navbar') %>
        
        <div class="container-fluid py-4">
            <!-- رسائل النجاح/الخطأ -->
            <% if (success) { %>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                <% if (success === 'user_created') { %>
                    <%= lang === 'ar' ? 'تم إضافة المستخدم بنجاح!' : 'User added successfully!' %>
                <% } else if (success === 'user_updated') { %>
                    <%= lang === 'ar' ? 'تم تحديث بيانات المستخدم بنجاح!' : 'User updated successfully!' %>
                <% } else if (success === 'user_deleted') { %>
                    <%= lang === 'ar' ? 'تم حذف المستخدم بنجاح!' : 'User deleted successfully!' %>
                <% } %>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            <% } %>
            
            <% if (error) { %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <% if (error === 'user_create_failed') { %>
                    <%= lang === 'ar' ? 'فشل في إضافة المستخدم' : 'Failed to add user' %>
                <% } else if (error === 'user_update_failed') { %>
                    <%= lang === 'ar' ? 'فشل في تحديث بيانات المستخدم' : 'Failed to update user' %>
                <% } else if (error === 'user_delete_failed') { %>
                    <%= lang === 'ar' ? 'فشل في حذف المستخدم' : 'Failed to delete user' %>
                <% } %>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            <% } %>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="text-dark mb-0">
                    <i class="fas fa-users text-gold me-2"></i>
                    <%= title %>
                </h4>
                <button class="btn btn-luxury" data-bs-toggle="modal" data-bs-target="#addUserModal">
                    <i class="fas fa-plus me-2"></i>
                    <%= lang === 'ar' ? 'إضافة مستخدم' : 'Add User' %>
                </button>
            </div>

            <!-- جدول المستخدمين -->
            <div class="luxury-card">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th><%= lang === 'ar' ? 'المستخدم' : 'User' %></th>
                                <th><%= lang === 'ar' ? 'اسم المستخدم' : 'Username' %></th>
                                <th><%= lang === 'ar' ? 'الدور' : 'Role' %></th>
                                <th><%= lang === 'ar' ? 'الإدارة' : 'Department' %></th>
                                <th><%= lang === 'ar' ? 'الحالة' : 'Status' %></th>
                                <th><%= lang === 'ar' ? 'آخر دخول' : 'Last Login' %></th>
                                <th><%= lang === 'ar' ? 'الإجراءات' : 'Actions' %></th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (users && users.length > 0) { %>
                                <% users.forEach(user => { %>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-placeholder bg-gold text-dark rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                                <i class="fas fa-user"></i>
                                            </div>
                                            <div>
                                                <strong><%= user.name %></strong>
                                                <br>
                                                <small class="text-muted"><%= user.email || 'لا يوجد بريد إلكتروني' %></small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <code><%= user.username %></code>
                                    </td>
                                    <td>
                                        <% const roleColors = {
                                            'مدير': 'dark',
                                            'مشرف': 'primary',
                                            'موظف': 'secondary'
                                        } %>
                                        <span class="badge bg-<%= roleColors[user.role] || 'secondary' %>">
                                            <%= user.role %>
                                        </span>
                                    </td>
                                    <td>
                                        <% if (user.department) { %>
                                            <span class="text-dark"><%= user.department.name.ar %></span>
                                        <% } else { %>
                                            <span class="text-muted">-</span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <% if (user.isActive) { %>
                                            <span class="status-badge status-active">
                                                <i class="fas fa-check-circle me-1"></i>
                                                <%= t.active %>
                                            </span>
                                        <% } else { %>
                                            <span class="status-badge status-inactive">
                                                <i class="fas fa-times-circle me-1"></i>
                                                <%= t.inactive %>
                                            </span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <small>
                                            <% if (user.lastLogin) { %>
                                                <%= new Date(user.lastLogin).toLocaleDateString(lang === 'ar' ? 'ar-SA' : 'en-US') %>
                                            <% } else { %>
                                                <span class="text-muted">-</span>
                                            <% } %>
                                        </small>
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-luxury" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#editUserModal"
                                                    data-id="<%= user._id %>"
                                                    data-name="<%= user.name %>"
                                                    data-username="<%= user.username %>"
                                                    data-role="<%= user.role %>"
                                                    data-department="<%= user.department?._id %>"
                                                    data-isactive="<%= user.isActive %>">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <form action="/admin/users/<%= user._id %>?_method=DELETE&lang=<%= lang %>" method="POST" class="d-inline">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                        onclick="return confirm('<%= lang === 'ar' ? 'هل أنت متأكد من حذف هذا المستخدم؟' : 'Are you sure you want to delete this user?' %>')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                <% }) %>
                            <% } else { %>
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                        <p class="text-muted"><%= lang === 'ar' ? 'لا توجد مستخدمين' : 'No users found' %></p>
                                        <button class="btn btn-luxury" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                            <i class="fas fa-plus me-2"></i>
                                            <%= lang === 'ar' ? 'إضافة أول مستخدم' : 'Add First User' %>
                                        </button>
                                    </td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal إضافة مستخدم -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-gold">
                        <i class="fas fa-user-plus me-2"></i>
                        <%= lang === 'ar' ? 'إضافة مستخدم جديد' : 'Add New User' %>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/admin/users?lang=<%= lang %>" method="POST">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><%= lang === 'ar' ? 'اسم المستخدم' : 'User Name' %> *</label>
                                    <input type="text" class="form-control" name="name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><%= lang === 'ar' ? 'اسم الدخول' : 'Username' %> *</label>
                                    <input type="text" class="form-control" name="username" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><%= lang === 'ar' ? 'كلمة المرور' : 'Password' %> *</label>
                                    <input type="password" class="form-control" name="password" required minlength="6">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><%= lang === 'ar' ? 'الدور' : 'Role' %> *</label>
                                    <select class="form-select" name="role" required>
                                        <option value=""><%= lang === 'ar' ? 'اختر الدور' : 'Select Role' %></option>
                                        <option value="مدير"><%= lang === 'ar' ? 'مدير' : 'Manager' %></option>
                                        <option value="مشرف"><%= lang === 'ar' ? 'مشرف' : 'Supervisor' %></option>
                                        <option value="موظف"><%= lang === 'ar' ? 'موظف' : 'Employee' %></option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><%= lang === 'ar' ? 'الإدارة' : 'Department' %></label>
                                    <select class="form-select" name="department">
                                        <option value=""><%= lang === 'ar' ? 'اختر الإدارة' : 'Select Department' %></option>
                                        <% departments.forEach(dept => { %>
                                            <option value="<%= dept._id %>"><%= dept.name.ar %></option>
                                        <% }) %>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><%= lang === 'ar' ? 'البريد الإلكتروني' : 'Email' %></label>
                                    <input type="email" class="form-control" name="email">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="isActive" id="isActive" checked>
                                <label class="form-check-label" for="isActive">
                                    <%= lang === 'ar' ? 'مستخدم نشط' : 'Active User' %>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <%= t.cancel %>
                        </button>
                        <button type="submit" class="btn btn-luxury">
                            <i class="fas fa-save me-2"></i>
                            <%= t.save %>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal تعديل مستخدم -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-gold">
                        <i class="fas fa-edit me-2"></i>
                        <%= lang === 'ar' ? 'تعديل بيانات المستخدم' : 'Edit User' %>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editUserForm" method="POST">
                    <input type="hidden" name="_method" value="PUT">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><%= lang === 'ar' ? 'اسم المستخدم' : 'User Name' %> *</label>
                                    <input type="text" class="form-control" name="name" id="editName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><%= lang === 'ar' ? 'اسم الدخول' : 'Username' %> *</label>
                                    <input type="text" class="form-control" name="username" id="editUsername" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><%= lang === 'ar' ? 'كلمة المرور الجديدة' : 'New Password' %></label>
                                    <input type="password" class="form-control" name="password" minlength="6">
                                    <div class="form-text"><%= lang === 'ar' ? 'اتركه فارغاً إذا لم ترد تغيير كلمة المرور' : 'Leave blank if you don\'t want to change password' %></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><%= lang === 'ar' ? 'الدور' : 'Role' %> *</label>
                                    <select class="form-select" name="role" id="editRole" required>
                                        <option value=""><%= lang === 'ar' ? 'اختر الدور' : 'Select Role' %></option>
                                        <option value="مدير"><%= lang === 'ar' ? 'مدير' : 'Manager' %></option>
                                        <option value="مشرف"><%= lang === 'ar' ? 'مشرف' : 'Supervisor' %></option>
                                        <option value="موظف"><%= lang === 'ar' ? 'موظف' : 'Employee' %></option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><%= lang === 'ar' ? 'الإدارة' : 'Department' %></label>
                                    <select class="form-select" name="department" id="editDepartment">
                                        <option value=""><%= lang === 'ar' ? 'اختر الإدارة' : 'Select Department' %></option>
                                        <% departments.forEach(dept => { %>
                                            <option value="<%= dept._id %>"><%= dept.name.ar %></option>
                                        <% }) %>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><%= lang === 'ar' ? 'البريد الإلكتروني' : 'Email' %></label>
                                    <input type="email" class="form-control" name="email" id="editEmail">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="isActive" id="editIsActive">
                                <label class="form-check-label" for="editIsActive">
                                    <%= lang === 'ar' ? 'مستخدم نشط' : 'Active User' %>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <%= t.cancel %>
                        </button>
                        <button type="submit" class="btn btn-luxury">
                            <i class="fas fa-save me-2"></i>
                            <%= t.update %>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <%- include('../partials/scripts') %>
    
    <script>
        // تعديل بيانات المستخدم
        document.addEventListener('DOMContentLoaded', function() {
            const editModal = document.getElementById('editUserModal');
            if (editModal) {
                editModal.addEventListener('show.bs.modal', function(event) {
                    const button = event.relatedTarget;
                    const id = button.getAttribute('data-id');
                    const form = document.getElementById('editUserForm');
                    
                    form.action = `/admin/users/${id}?lang=<%= lang %>`;
                    document.getElementById('editName').value = button.getAttribute('data-name');
                    document.getElementById('editUsername').value = button.getAttribute('data-username');
                    document.getElementById('editRole').value = button.getAttribute('data-role');
                    document.getElementById('editDepartment').value = button.getAttribute('data-department');
                    document.getElementById('editIsActive').checked = button.getAttribute('data-isactive') === 'true';
                });
            }
        });
    </script>
</body>
</html>